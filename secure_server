import socket
from cryptography.fernet import Fernet

with open("secret.key", "rb") as key_file:
    key = key_file.read()

cipher = Fernet(key)

# Server configuration
HOST = '0.0.0.0'
PORT = 65432

# Create TCP socket
server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_socket.bind((HOST, PORT))
server_socket.listen()

print(f"Server started and listening on {HOST}:{PORT}")

# Accept connection
conn, addr = server_socket.accept()
print(f"Connected by {addr}")

while True:
    encrypted_data = conn.recv(1024)
    if not encrypted_data:
        break

    # ----------- DECRYPT incoming message -----------
    try:
        decrypted_message = cipher.decrypt(encrypted_data).decode()
    except Exception as e:
        print("Decryption error:", e)
        break

    print(f"Decrypted from client: {decrypted_message}")

    # Process message
    response_message = decrypted_message.upper()

    # ----------- ENCRYPT response -----------
    encrypted_response = cipher.encrypt(response_message.encode())
    conn.sendall(encrypted_response)

# Close
conn.close()
server_socket.close()
print("Server closed.")
